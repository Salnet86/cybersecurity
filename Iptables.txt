#!/bin/bash
# ================================================
# IPTABLES CHEAT-SHEET
# Raccolta di comandi iptables + commenti (IPv4)
# Autore: SalvoNet
# ================================================

# ============================
# ▪️ Visualizzare regole
# ============================
iptables -L                       # Lista regole (formato tabellare leggibile)
iptables -L -v                    # Lista con contatori byte/packet
iptables -L -n                    # Non risolve nomi (più veloce)
iptables -L --line-numbers        # Mostra numeri di riga (utile per eliminare/regolare)
iptables -S                       # Stampa regole in formato comando (recreabile)
iptables -t nat -L                # Lista regole della tabella 'nat'
iptables -t mangle -L             # Lista regole della tabella 'mangle'
iptables -t raw -L                # Lista regole della tabella 'raw'
iptables -t security -L           # Lista tabella 'security' (se disponibile)

# ============================
# ▪️ Aggiungere / Inserire / Sostituire / Cancellare regole
# ============================
iptables -A INPUT -p tcp --dport 22 -j ACCEPT
# Aggiunge (-A) alla catena INPUT regola che accetta TCP porta 22 (SSH)

iptables -I INPUT 1 -p tcp --dport 22 -j ACCEPT
# Inserisce (-I) la regola come prima regola (posizione 1)

iptables -R INPUT 3 -p tcp --dport 2222 -j ACCEPT
# Sostituisce (-R) la regola in posizione 3 nella catena INPUT

iptables -D INPUT -p tcp --dport 22 -j ACCEPT
# Cancella (-D) la prima corrispondenza della regola specificata

iptables -D INPUT 5
# Cancella la regola con numero di riga 5 nella catena INPUT

# ============================
# ▪️ Creare / Eliminare / Resettare catene
# ============================
iptables -N MYCHAIN
# Crea una nuova catena utente MYCHAIN

iptables -X MYCHAIN
# Elimina una catena utente (deve essere vuota)

iptables -F MYCHAIN
# Svuota (flush) tutte le regole della catena MYCHAIN

iptables -F
# Svuota tutte le regole in tutte le catene della tabella filter

iptables -Z
# Azzera i contatori di byte/packet per tutte le regole

# ============================
# ▪️ Politiche predefinite
# ============================
iptables -P INPUT DROP
iptables -P FORWARD DROP
iptables -P OUTPUT ACCEPT
# Imposta policy predefinite: INPUT e FORWARD drop, OUTPUT accept

# ============================
# ▪️ Filtri comuni / esempi pratici
# ============================
# 1) Permettere traffico già stabilito/relativo (essenziale)
iptables -A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT

# 2) Permettere loopback
iptables -A INPUT -i lo -j ACCEPT

# 3) Permettere SSH (porta 22)
iptables -A INPUT -p tcp --dport 22 -m conntrack --ctstate NEW -j ACCEPT

# 4) Permettere HTTP/HTTPS
iptables -A INPUT -p tcp --dport 80 -m conntrack --ctstate NEW -j ACCEPT
iptables -A INPUT -p tcp --dport 443 -m conntrack --ctstate NEW -j ACCEPT

# 5) Consentire una sottorete (es. 192.168.1.0/24)
iptables -A INPUT -s 192.168.1.0/24 -j ACCEPT

# 6) Bloccare un singolo IP
iptables -A INPUT -s 203.0.113.45 -j DROP

# 7) Bloccare intera rete
iptables -A INPUT -s 203.0.113.0/24 -j DROP

# 8) Limitare tentativi di connessione (rate-limit)
iptables -A INPUT -p tcp --dport 22 -m conntrack --ctstate NEW -m limit --limit 3/min --limit-burst 5 -j ACCEPT

# 9) Bloccare ping (ICMP echo-request)
iptables -A INPUT -p icmp --icmp-type echo-request -j DROP

# 10) Consentire ping (alternativa)
iptables -A INPUT -p icmp --icmp-type echo-request -j ACCEPT

# 11) Permettere porta range (es. 10000-20000)
iptables -A INPUT -p tcp --dport 10000:20000 -j ACCEPT

# 12) Rifiutare con REJECT e messaggio
iptables -A INPUT -s 198.51.100.10 -j REJECT --reject-with icmp-port-unreachable

# 13) Loggare pacchetti prima di droppare
iptables -A INPUT -s 198.51.100.11 -j LOG --log-prefix "DROP BAD IP: " --log-level 4
iptables -A INPUT -s 198.51.100.11 -j DROP

# ============================
# ▪️ NAT e Port Forwarding (tabella nat)
# ============================
# 1) Port forwarding: /PREROUTING DNAT (porta pubblica 2222 -> interno 192.168.1.100:22)
iptables -t nat -A PREROUTING -p tcp --dport 2222 -j DNAT --to-destination 192.168.1.100:22

# 2) Masquerade (NAT per connessioni in uscita su interfaccia eth0)
iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE

# 3) Redirigere porta locale su porta diversa (es. redir HTTP -> 8080)
iptables -t nat -A PREROUTING -p tcp --dport 80 -j REDIRECT --to-ports 8080

# 4) SNAT (IP sorgente statico, usare quando hai IP statico pubblico)
iptables -t nat -A POSTROUTING -o eth0 -j SNAT --to-source 198.51.100.5

# ============================
# ▪️ Filtri avanzati / moduli utili
# ============================
# Conntrack / state
iptables -A INPUT -m conntrack --ctstate INVALID -j DROP   # scarta pacchetti invalidi

# Limitare pacchetti LOG per evitare flooding
iptables -A INPUT -p tcp --dport 22 -m limit --limit 5/min -j LOG --log-prefix "SSH CONN: "

# Bloccare SYN flood (esempio semplice)
iptables -N SYN_FLOOD
iptables -A INPUT -p tcp --syn -j SYN_FLOOD
iptables -A SYN_FLOOD -m limit --limit 10/s --limit-burst 20 -j RETURN
iptables -A SYN_FLOOD -j DROP

# Usare il modulo recent per bloccare host che fanno troppe connessioni
iptables -A INPUT -p tcp --dport 22 -m recent --name SSH --set
iptables -A INPUT -p tcp --dport 22 -m recent --name SSH --update --seconds 60 --hitcount 10 -j DROP

# Bloccare pacchetti con flag TCP sospetti
iptables -A INPUT -p tcp --tcp-flags ALL NONE -j DROP   # NULL scan
iptables -A INPUT -p tcp --tcp-flags ALL ALL -j DROP    # XMAS scan

# ============================
# ▪️ Debug e contatori
# ============================
iptables -L -v -n --line-numbers    # vedere quanti pacchetti/byte matchano ogni regola
iptables -Z INPUT 0                 # azzera contatori per INPUT (specificare catena)

# ============================
# ▪️ Salvare / Ripristinare regole
# ============================
iptables-save > /etc/iptables.rules            # salva tutte le regole in file (formato riutilizzabile)
iptables-restore < /etc/iptables.rules         # ripristina regole da file

# Distribuzioni Debian/Ubuntu:
iptables-save > /etc/iptables/rules.v4
# e per ripristinare al boot puoi installare netfilter-persistent:
# sudo apt install netfilter-persistent
# sudo netfilter-persistent save
# sudo netfilter-persistent reload

# CentOS/RHEL (servizi persistenti variano): usare firewall-cmd o salvare con service iptables save (sysv)
# systemctl enable iptables (se presente)

# ============================
# ▪️ Esempio: script minimo per impostare firewall "basico"
# ============================
# (1) flush
iptables -F
iptables -t nat -F
iptables -t mangle -F
iptables -X

# (2) policy di default
iptables -P INPUT DROP
iptables -P FORWARD DROP
iptables -P OUTPUT ACCEPT

# (3) loopback e connessioni stabilite
iptables -A INPUT -i lo -j ACCEPT
iptables -A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT

# (4) SSH
iptables -A INPUT -p tcp --dport 22 -m conntrack --ctstate NEW -j ACCEPT

# (5) HTTP/HTTPS
iptables -A INPUT -p tcp --dport 80 -m conntrack --ctstate NEW -j ACCEPT
iptables -A INPUT -p tcp --dport 443 -m conntrack --ctstate NEW -j ACCEPT

# (6) salva (esempio per Debian/Ubuntu)
iptables-save > /etc/iptables/rules.v4

# ============================
# ▪️ Comandi utili di manutenzione
# ============================
# Visualizza regole NAT con contatori:
iptables -t nat -L -v -n --line-numbers

# Mostra tutte le tabelle e catene in formato "comandi"
iptables-save    # stampa su stdout; utile per redirect su file

# Ripristino "prova" con iptables-apply (può rollback)
# iptables-apply /path/to/rules-file

# ============================
# ▪️ IPv6
# ============================
# Stessa sintassi per IPv6 ma con ip6tables
ip6tables -L -v -n

# ============================
# ▪️ Note finali e raccomandazioni
# ============================
# - Testa sempre le regole su un ambiente di prova o con console di recovery (se stai lavorando su server remoto, evita di bloccarti fuori).
# - Usa policy conservative (DROP all incoming) e poi apri solo le porte necessarie.
# - Preferisci "conntrack ESTABLISHED,RELATED" per permettere le risposte in uscita.
# - Considera fail2ban o altre soluzioni per mitigare brute-force e per rendere la gestione più dinamica.
# - Per nuove installazioni prendere in considerazione nftables (sostituto moderno di iptables).
